name: ğŸš€ Build RhytmiX APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:
  build:
    name: ğŸ“± Build APK
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        arch: [arm64-v8a, armeabi-v7a]
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ˜ Setup Gradle
      uses: gradle/gradle-build-action@v2
      
    - name: ğŸ“‹ Make Gradlew Executable
      run: chmod +x ./gradlew
      
    - name: ğŸ§¹ Clean Project
      run: ./gradlew clean
      
    - name: ğŸ”¨ Build Debug APK (${{ matrix.arch }})
      run: ./gradlew assembleDebug -Pandroid.injected.build.abi=${{ matrix.arch }}
      
    - name: ğŸ“¦ Upload APK (${{ matrix.arch }})
      uses: actions/upload-artifact@v4
      with:
        name: RhytmiX-${{ matrix.arch }}-${{ github.sha }}
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 30
        
    - name: ğŸ·ï¸ Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: app/build/outputs/apk/debug/*.apk
        name: "RhytmiX v${{ github.ref_name }}"
        body: |
          ğŸµ **RhytmiX Music Player**
          
          ### ğŸ“± Downloads:
          - **ARM64-v8a**: For modern 64-bit devices
          - **ARMv7a**: For older 32-bit devices
          
          ### âœ¨ Features:
          - ğŸ¨ Beautiful Material You Design
          - ğŸµ High-Quality Music Playback
          - ğŸ“± Intuitive User Interface
          - ğŸŒ“ Dark/Light Theme Support
          - â¤ï¸ Favorites & Playlists
          
          ### ğŸ› Bug Fixes & Improvements:
          - Performance optimizations
          - UI/UX enhancements
          - Bug fixes and stability improvements
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ˜ Setup Gradle
      uses: gradle/gradle-build-action@v2
      
    - name: ğŸ“‹ Make Gradlew Executable
      run: chmod +x ./gradlew
      
    - name: ğŸ§ª Run Unit Tests
      run: ./gradlew testDebugUnitTest
      
    - name: ğŸ“Š Generate Test Report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: ğŸ“‹ Test Results
        path: '**/build/test-results/testDebugUnitTest/TEST-*.xml'
        reporter: java-junit
